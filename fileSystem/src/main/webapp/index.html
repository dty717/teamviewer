<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <title>Hello World</title>
        <style type="text/css" media="all">
            body{
                height: 90hv;
                width: 100%;
            }
            
            img{
                width:100%
                height:100%
            }
            .textare-margin {
                margin: 0 auto;
                width: 80%;
                position: fixed;
                bottom: -30px;
                left: 10%;
            }
    
            .float_left {
                text-align: left;
                background: #ddd;
                float: left;
            }
    
            .float_right {
                text-align: right;
                background: #ddd;
                float: right;
            }
        </style>
        <style id="test_css"></style>
        <script src="https://kazuhikoarase.github.io/qrcode-generator/js/qrcode.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.3.0/sockjs.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.js"></script>
        
    </head>
    <body>
        <img id="monitor" src="/monitor?type=null" alt="The Scream"/>
        
        
        <button  ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">upload</button>
        <button  onclick="openFile()">download</button>
        <button  onclick="sendKey(KeyEvent.VK_BACK_SPACE)">backspace</button>
        <button  onclick="sendKey(KeyEvent.VK_WINDOWS)">window</button>

        <textarea class="form-control  badge-light textare-margin" id="exampleFormControlTextarea1" rows="3"></textarea>
        <script type="text/javascript" charset="utf-8">
            const KeyEvent={VK_BACK_SPACE:8,VK_WINDOWS:0x020C};
            
            path="login";
            currentFile="";
            function openFile(){
                open("/"+path+currentFile);
            }
            function dropHandler(ev)
            {
                ev.preventDefault();
                if (ev.dataTransfer.items)
                {
                    for (var i = 0; i < ev.dataTransfer.items.length; i++)
                    {
                        if (ev.dataTransfer.items[i].kind === 'file')
                        {
                            var file = ev.dataTransfer.items[i].getAsFile();
                            //console.log('... file[' + i + '].name = ' + file.name);
                            uploadFile(file);
                            break;
                        }
                    }
                }
                else
                {
                    uploadFile(ev.dataTransfer.files[0]);
                }
                removeDragData(ev)
            }

            function dragOverHandler(ev)
            {
                ev.preventDefault();
            }

            function removeDragData(ev)
            {
                if (ev.dataTransfer.items)
                {
                    ev.dataTransfer.items.clear();
                }
                else
                {
                    ev.dataTransfer.clearData();
                }
            }
            
            
            function uploadFile(file){
             
                if (file == undefined)
                    return;
                var formData = new FormData();
                if(path!=undefined)
                    formData.append("path", path);
                console.log(path)
                formData.append("file", file);
                $.ajax(
                {
                    url: 'uploadFile',
                    type: 'POST',
                    data: formData,
                    enctype: 'multipart/form-data',
                    //contentType:"application/x-javascript; charset:ISO-8859-1"
                    processData: false,
                    contentType: false,
                    cache: false,
                    success: function(response)
                    {
                        alert("ok")
                    }
                });
               
                
            }
            
            function getWidth(obj){
                return Math.max(
                    document.body.scrollWidth,
                    document.documentElement.scrollWidth,
                    document.body.offsetWidth,
                    document.documentElement.offsetWidth,
                    document.documentElement.clientWidth,
                    obj
                ) - 50;
            }

            function getHeight(obj){
                return Math.max(
                    document.body.scrollHeight,
                    document.documentElement.scrollHeight,
                    document.body.offsetHeight,
                    document.documentElement.offsetHeight,
                    document.documentElement.clientHeight,
                    obj
                ) - 50;
            }
            var monitor = document.getElementById("monitor");
            var height = getHeight(monitor.height)
            var width = getWidth(monitor.width)
            monitor.height = height;
            monitor.width = width;
            var tag = true;
            //document.onkeypress = fkey
            document.onkeyup = function(e){
                if(e.target==document.body){
                    fkeyup(e);
                }    
            }
            document.onkeydown = function(e){
                if(e.target==document.body){
                    fkey(e);
                }    
            }
            // document.getElementById("monitor").onkeydown = fkey;
        
            var wasPressed = false;
            var key_e = {
                timeStamp: 0
            };

            function sendKey(obj){
                $.ajax(
                {
                    url: "control",
                    method: "GET",
                    data:
                    {
                        type: "keyDown",
                        code: obj
                    },
                    contentType: "application/json; charset=utf-8",
                    success: (function(msg)
                    {
                        //console.log(msg, msg.type)
                    })
                });
                $.ajax(
                {
                    url: "control",
                    method: "GET",
                    data:
                    {
                        type: "keyUp",
                        code: obj
                    },
                    contentType: "application/json; charset=utf-8",
                    success: (function(msg)
                    {
                        //console.log(msg, msg.type)
                    })
                });

            }
        
            function fkey(e){
                e = e || window.event;
                var key = e.key || e.keyCode;
                console.log(e.timeStamp - key_e.timeStamp);
                key_e = e;
                console.log("key down:", e);
        
                $.ajax(
                {
                    url: "control",
                    method: "GET",
                    data:
                    {
                        type: "keyDown",
                        code: e.keyCode
                    },
                    contentType: "application/json; charset=utf-8",
                    success: (function(msg)
                    {
                        //console.log(msg, msg.type)
                    })
                });
                return false;
            }
        
            function fkeyup(e)
            {
                e = e || window.event;
                var key = e.key || e.keyCode;
                //console.log(e.timeStamp-key_e.timeStamp);
                key_e = e;
                console.log("key up:", e);
                if (e.type == "scroll")
                {
        
        
                }
                $.ajax(
                {
                    url: "control",
                    method: "GET",
                    data:
                    {
                        type: "keyUp",
                        code: e.keyCode
                    },
                    contentType: "application/json; charset=utf-8",
                    success: (function(msg)
                    {
                        //console.log(msg, msg.type)
                    })
                });
                //return false;
            }
            var runOnWheel = function(e)
            {
                if (e.deltaY < 0)
                {
                    // upscroll code
                    $.ajax(
                    {
                        url: "control",
                        method: "GET",
                        data:
                        {
                            type: "scroll",
                            code: 1
                        },
                        contentType: "application/json; charset=utf-8",
                        success: (function(msg)
                        {
                            //console.log(msg, msg.type)
                        })
                    });
                }
                if (e.deltaY > 0)
                {
                    // downscroll code
                    $.ajax(
                    {
                        url: "control",
                        method: "GET",
                        data:
                        {
                            type: "scroll",
                            code: 0
                        },
                        contentType: "application/json; charset=utf-8",
                        success: (function(msg)
                        {
                            //console.log(msg, msg.type)
                        })
                    });
                }
            };
            document.onwheel = runOnWheel;
            function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            async function demo_test(fn) {
                // Sleep in loop
                for (let i = 0; i < 3; i++) {
                    //if (i === 3)
                    await sleep(1000);
                    fn()
                }
            }

            monitor.onclick=function(e){
                
                console.log("click")
                var _e=e;
                demo_test(function(){
                    monitor.src = "/monitor?type=click&x=" + parseInt(_e.clientX /
                    width * 100) + "&y=" + parseInt(_e.clientY / height *
                    100);
                })
            }
            monitor.ondblclick=function(e){
                var _e=e;
                demo_test(function(){
                    monitor.src = "/monitor?type=dblclick&x=" + parseInt(_e.clientX /
                    width * 100) + "&y=" + parseInt(_e.clientY / height *
                    100);
                })
            }
            monitor.oncontextmenu=function(e){
                var _e=e;
                demo_test(function(){
                    monitor.src = "/monitor?type=oncontextmenu&x=" + parseInt(_e.clientX /
                    width * 100) + "&y=" + parseInt(_e.clientY / height *
                    100);
                })
            }
            
            /*
            $("#monitor").on("click", function(e)
            {
                console.log("click")
                var _e=e;
                demo_test(function(){
                    monitor.src = "/monitor?type=click&x=" + parseInt(_e.clientX /
                    width * 100) + "&y=" + parseInt(_e.clientY / height *
                    100);
                })

            });
            */
            /*$("#monitor").on("dblclick", function(e)
            {
                console.log("db")
                monitor.src = "/monitor?type=dblclick&x=" + parseInt(e.clientX /
                    width * 100) + "&y=" + parseInt(e.clientY / height *
                    100);
            });*/
            /*$("#monitor").on("contextmenu", function(e)
            {
                monitor.src = "/monitor?type=contextmenu&x=" + parseInt(e.clientX /
                    width * 100) + "&y=" + parseInt(e.clientY / height *
                    100);
                return false
            });*/
            
            $('#exampleFormControlTextarea1').on('input', function (e) {
                clearTimeout(changeTimeId);
                changeTimeId=setTimeout(newMessage, 3000)
                if (!changing) {
                    changing=true;
                    if(clearFlag){
                        setTimeout(clearContent,30000);
                        clearFlag=false;
                    }
                }
            });
            var changeTimeId;
            var changing = false;
            var isIPhone=false;
            var clearFlag=true;

            if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                document.getElementById("content").style.fontSize="45px"
                document.getElementById("exampleFormControlTextarea1").style.fontSize="45px";
                isIPhone=true;
            }
            
            function clearContent(){
                clearFlag=true;
            }

            
            function newMessage() {
                var message = $('#exampleFormControlTextarea1').val();
                changing = false;
                if (message == "") {
                    return;
                }
                var sendUrl="/speaking";

                
                var data;
                if(sendUrl=="/topic/speech"){
                    data={content:message};
                }else{
                    data={msg: message};
                }
                $.ajax({
                    url: sendUrl,
                    data: data
                })
                    .done(function (data) {
                        console.log(data);
                    });
                
                if(isIPhone){
                    $('#exampleFormControlTextarea1').focus();
                    setTimeout(function() {
                        $('#exampleFormControlTextarea1').val('');    
                    }, 100);
                }else{
                    $('#exampleFormControlTextarea1').focus();
                    $('#exampleFormControlTextarea1').val('');    
                }
                
            }

            
        </script>
    </body>
</html>